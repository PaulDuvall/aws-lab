AWSTemplateFormatVersion: 2010-09-09
Description: This deploys a PHP application using Elastic Beanstalk

Parameters:
  VpcCidrBlock:
    Type:    String
    Default: 10.1.0.0/16
  Subnet1CidrBlock:
    Type:    String
    Default: 10.1.10.0/24
  Subnet2CidrBlock:
    Type:    String
    Default: 10.1.11.0/24

Resources:
  #
  # VPC for EB Applications
  #

  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock:          !Ref VpcCidrBlock
      EnableDnsSupport:   true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-VPC

  InternetGateway:
    Type:      AWS::EC2::InternetGateway
    DependsOn: VPC
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-InternetGateway

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId:             !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet1:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId:               !Ref VPC
        CidrBlock:           !Ref Subnet1CidrBlock
        AvailabilityZone:    !Select [ 0, !GetAZs ]
        MapPublicIpOnLaunch: true
        Tags:
        - Key:   Name
          Value: !Sub ${AWS::StackName}-PublicSubnet1

  PublicSubnet2:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId:               !Ref VPC
        CidrBlock:           !Ref Subnet2CidrBlock
        AvailabilityZone:    !Select [ 1, !GetAZs ]
        MapPublicIpOnLaunch: true
        Tags:
        - Key:   Name
          Value: !Sub ${AWS::StackName}-PublicSubnet2

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
      - Key:   Name
        Value: !Sub ${AWS::StackName}-PublicRouteTable

  # Entries for PublicRouteTable
  InternetGatewayRoute:
    Type:      AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId:         !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:            !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:     !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:     !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  #
  # PHP Application
  #

  WebApp:
    Type: AWS::ElasticBeanstalk::Application
    # Explicitly state this to avoid a race condition
    DependsOn: WebAppInstanceProfile
    Properties:
      ApplicationName: Web Application
      Description: AWS Elastic Beanstalk PHP Sample Application

  WebAppVersion:
    Type: AWS::ElasticBeanstalk::ApplicationVersion
    Properties:
      ApplicationName: !Ref WebApp
      Description:     WebApp v1.3
      SourceBundle:
        S3Bucket: elastic-beanstalk-sample
        # Copied from https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/tutorials.html
        S3Key:    php.zip

  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-beanstalk-environment.html
  WebAppEnvironment:
    Type: AWS::ElasticBeanstalk::Environment
    Properties:
      ApplicationName:  !Ref WebApp
      Description:      !Sub Environemnt for ${!Ref WebApp}
      TemplateName:     !Ref WebAppConfigurationTemplate
      VersionLabel:     !Ref WebAppVersion

  # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticbeanstalk-configurationtemplate.html
  WebAppConfigurationTemplate:
    Type: AWS::ElasticBeanstalk::ConfigurationTemplate
    Properties:
      ApplicationName:   !Ref WebApp
      Description:       !Sub Configuration for ${!Ref WebApp}
      # Get official list of SolutionStackNames via `aws elasticbeanstalk  list-available-solution-stacks`
      SolutionStackName: 64bit Amazon Linux 2 v3.1.3 running PHP 7.4
      # https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/command-options.html
      OptionSettings:
        - Namespace:  aws:autoscaling:asg
          OptionName: MinSize
          Value:      1

        - Namespace:  aws:autoscaling:asg
          OptionName: MaxSize
          Value:      2

        - Namespace:  aws:elasticbeanstalk:environment
          OptionName: EnvironmentType
          Value:      LoadBalanced

        - Namespace:  aws:autoscaling:launchconfiguration
          OptionName: IamInstanceProfile
          Value:      !GetAtt WebAppInstanceProfile.Arn

        - Namespace:  aws:ec2:vpc
          OptionName: VPCId
          Value:      !Ref VPC

        - Namespace:  aws:ec2:vpc
          OptionName: Subnets
          Value:      !Join [ ",", [ !Ref PublicSubnet1, !Ref PublicSubnet2 ] ]

        # - Namespace:  aws:ec2:vpc
        #   OptionName: DbSubnets
        #   Value:      !Sub "${!Ref PublicSubnet1},${!Ref PublicSubnet2}"

  WebAppInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref WebAppInstanceProfileRole

  WebAppInstanceProfileRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: WebAppInstanceProfileRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
              - ec2.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      # https://aws.amazon.com/premiumsupport/knowledge-center/cloudformation-attach-managed-policy/
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSElasticBeanstalkWebTier
        - arn:aws:iam::aws:policy/AWSElasticBeanstalkWorkerTier
